#!/usr/bin/env bash

if [ -z "$1" ]; then
    echo usage: ${0##*/} OUTPUT_BASE_NAME
else
    tmp_dir=$(mktemp -d --tmpdir)
    base=${1##*/}
    { cat - \
        | tee /dev/stderr 2>&1 1>&3 3>&- \
        | magick - "$tmp_dir/$base.jpg"; } 3>&1 1>&2 \
        | magick - "$tmp_dir/$base.webp"
    output=$(keepsmallest "$tmp_dir/$base.jpg" "$tmp_dir/$base.webp")
    outname="${output##*/}"
    outdir="${1%/*}"
    if [ "$outdir" = "$base" ]; then
        target=$outname
    else
        target=$outdir/$outname
    fi
    echo $target
    mv "$output" "$target"
    rmdir "$tmp_dir"
fi

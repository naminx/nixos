#!/usr/bin/env bash

nullglob=$(shopt -p nullglob); shopt -s nullglob

if [ -z "$1" ]; then
    files=(*.png)
else
    files=( )
    for arg in "$@"; do
        if [ -f "$arg" ]; then
            files+=("$arg")
        elif [ -d "$arg" ]; then
            files+=("$arg"/*.png)
        fi
    done
fi

tmp_dir=$(mktemp -d --tmpdir)
tmp_dir2=$(mktemp -d --tmpdir)
for file in "${files[@]}"; do
    file_base=$(basename "$file")
    name="${file_base%.[^.]*}"
    ext="${file_base:${#name} + 1}"
    if [[ -z "$name" && -n "$ext" ]]; then
        name=".$ext"
        ext=""
    fi
    if [ "$ext" != "png" ]; then
        continue
    fi
    magick "$file" "$tmp_dir/$name.jpg"
    magick "$file" "$tmp_dir/$name.webp"
    magick "$file" miff:- | magick - "$tmp_dir2/$name.jpg"
    magick "$file" miff:- | magick - "$tmp_dir2/$name.webp"
    output="$(replace_with_smaller "$file" "$tmp_dir/$name.jpg" "$tmp_dir/$name.webp" "$tmp_dir2/$name.jpg" "$tmp_dir2/$name.webp")"
    if [ "$(dirname "$output")" = "." ]; then
        echo $(basename "$output")
    else
        echo $output
    fi
done
rmdir "$tmp_dir" "$tmp_dir2"

$nullglob; unset nullglob

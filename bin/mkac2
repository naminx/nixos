#!/usr/bin/env bash

nullglob=$(shopt -p nullglob); shopt -s nullglob extglob

is_uint() { case $1 in '' | *[!0-9]* ) return 1;; esac ;}

print_usage() {
    echo "usage: ${0##*/} left_edge [right_edge] [top_edge] [bottom_edge]"
}

LEFT_EDGE=$1
RIGHT_EDGE=${2:-0}
TOP_EDGE=${3:-0}
BOTTOM_EDGE=${4:-0}

if [ -z "$1" ] \
    || (! (is_uint "$LEFT_EDGE" || ([ "${LEFT_EDGE:0:1}" = "-" ] && is_uint "${LEFT_EDGE:1}"))) \
    || (! (is_uint "$RIGHT_EDGE" || ([ "${RIGHT_EDGE:0:1}" = "-" ] && is_uint "${RIGHT_EDGE:1}"))) \
    || (! (is_uint "$TOP_EDGE" || ([ "${TOP_EDGE:0:1}" = "-" ] && is_uint "${TOP_EDGE:1}"))) \
    || (! (is_uint "$BOTTOM_EDGE" || ([ "${BOTTOM_EDGE:0:1}" = "-" ] && is_uint "${BOTTOM_EDGE:1}"))); then
    print_usage
    exit 1
fi

files=([0-9][0-9][24680].@(jpg|png|webp))
GEOMETRY=$(magick identify -ping -format "%[w]x%[h]\n" "${files[1]}")

FULL_WIDTH=$((2*${GEOMETRY%%x*}-($RIGHT_EDGE)))
HALF_WIDTH=$(($FULL_WIDTH/2))
PAGE_WIDTH=$(($HALF_WIDTH-($LEFT_EDGE)))
TWO_PAGE_WIDTH=$((2*$PAGE_WIDTH))
FIRSTPAGE_LEFT=$((($FULL_WIDTH-$PAGE_WIDTH+1)/2))

FULL_HEIGHT=${GEOMETRY##*x}
HEIGHT=$(($FULL_HEIGHT-($TOP_EDGE)-($BOTTOM_EDGE)))
mkdir stock

for file001 in 001.@(jpg|png|webp); do
    cp $file001 stock
    ext=${file001##*.}
    mv 001.$ext 001b.$ext
done

tmp_dir=$(mktemp -d --tmpdir)
for right in "${files[@]}"; do
  if [ -f "$right" ]; then
    # strip extension
    right_num=${right%.*}

    left_num=$((10#$right_num+1))

    # append padding leading zeros
    left_num=00${left_num}
    left_num=${left_num:(-3)}
    left=${left_num}.jpg

    crop=${PAGE_WIDTH}x$HEIGHT+$HALF_WIDTH+$TOP_EDGE
    magick "$left" "$right" +append -crop $crop +repage "$tmp_dir/${right_num}a.jpg"
    magick "$left" "$right" +append -crop $crop +repage "$tmp_dir/${right_num}a.webp"
    output=$(demiff "$(keepsmallest "$tmp_dir/${right_num}a.jpg" "$tmp_dir/${right_num}a.webp" \
                    "$(magick "$left" "$right" +append -crop $crop +repage miff:- \
                           | minify "$tmp_dir/${right_num}a-miff")")")
    echo ${output##*/}
    mv "$output" .
    crop=${PAGE_WIDTH}x$HEIGHT+$LEFT_EDGE+$TOP_EDGE
    magick "$left" "$right" +append -crop $crop +repage "$tmp_dir/${right_num}c.jpg"
    magick "$left" "$right" +append -crop $crop +repage "$tmp_dir/${right_num}c.webp"
    output=$(demiff "$(keepsmallest "$tmp_dir/${right_num}c.jpg" "$tmp_dir/${right_num}c.webp" \
                    "$(magick "$left" "$right" +append -crop $crop +repage miff:- \
                           | minify "$tmp_dir/${right_num}c-miff")")")
    echo ${output##*/}
    mv "$output" .
    mv "$right" "$left" stock
  fi
done
rmdir "$tmp_dir"

$nullglob; unset nullglob
